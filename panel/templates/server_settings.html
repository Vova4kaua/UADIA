{% extends 'base.html' %}

{% block title %}–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –°–µ—Ä–≤–µ—Ä–∞{% endblock %}

{% block extra_css %}
<style>
    .settings-form {
        max-width: 800px;
    }

    .form-group {
        margin-bottom: 1.5rem;
    }

    .form-group label {
        display: block;
        color: #374151;
        font-weight: 500;
        margin-bottom: 0.5rem;
    }

    .form-group input,
    .form-group textarea,
    .form-group select {
        width: 100%;
        padding: 0.75rem;
        border: 1px solid #e5e7eb;
        border-radius: 5px;
        font-size: 1rem;
        transition: border-color 0.3s;
    }

    .form-group input:focus,
    .form-group textarea:focus,
    .form-group select:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .form-group textarea {
        min-height: 100px;
        resize: vertical;
    }

    .form-group small {
        display: block;
        color: #6b7280;
        margin-top: 0.25rem;
        font-size: 0.875rem;
    }

    .checkbox-group {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .checkbox-group input[type="checkbox"] {
        width: auto;
        cursor: pointer;
    }

    .form-actions {
        display: flex;
        gap: 1rem;
        margin-top: 2rem;
    }

    .alert {
        padding: 1rem;
        border-radius: 5px;
        margin-bottom: 1rem;
        font-weight: 500;
    }

    .alert-success {
        background: #d1fae5;
        color: #065f46;
        border: 1px solid #10b981;
    }

    .alert-error {
        background: #fee2e2;
        color: #991b1b;
        border: 1px solid #ef4444;
    }

    .loading-spinner {
        text-align: center;
        padding: 2rem;
        color: #667eea;
    }

    .section-title {
        color: #667eea;
        border-bottom: 2px solid #667eea;
        padding-bottom: 0.5rem;
        margin-bottom: 1.5rem;
        margin-top: 2rem;
    }
</style>
{% endblock %}

{% block content %}
<div id="alertContainer"></div>

<div class="card">
    <h2 style="color: #667eea; margin-bottom: 1.5rem;">
        ‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –°–µ—Ä–≤–µ—Ä–∞: <span id="serverName">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
    </h2>

    <div id="formContainer">
        <div class="loading-spinner">
            <p>‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫...</p>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    const serverId = {{ server_id }};
    const apiBase = '/api';
    let settingsId = null;

    function showAlert(message, type) {
        const alertContainer = document.getElementById('alertContainer');
        const alert = document.createElement('div');
        alert.className = `alert alert-${type}`;
        alert.textContent = message;
        alertContainer.appendChild(alert);
        
        setTimeout(() => {
            alert.remove();
        }, 5000);
    }

    async function loadServerInfo() {
        try {
            const response = await fetch(`${apiBase}/servers/${serverId}/`);
            const data = await response.json();
            document.getElementById('serverName').textContent = data.name;
        } catch (error) {
            console.error('Error loading server info:', error);
        }
    }

    async function loadSettings() {
        try {
            const response = await fetch(`${apiBase}/settings/?server=${serverId}`);
            const data = await response.json();

            const settings = (data.results || data)[0];
            
            if (settings) {
                settingsId = settings.id;
                displaySettingsForm(settings);
            } else {
                // –ï—Å–ª–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –Ω–µ—Ç, —Å–æ–∑–¥–∞–µ–º —Ñ–æ—Ä–º—É —Å –ø—É—Å—Ç—ã–º–∏ –∑–Ω–∞—á–µ–Ω–∏—è–º–∏
                displaySettingsForm({
                    max_players: 20,
                    difficulty: 'NORMAL',
                    gamemode: 'SURVIVAL',
                    pvp: true,
                    hardcore: false,
                    allow_flight: false,
                    spawn_monsters: true,
                    spawn_animals: true,
                    white_list: false,
                    motd: 'A Minecraft Server'
                });
            }
        } catch (error) {
            console.error('Error loading settings:', error);
            document.getElementById('formContainer').innerHTML = 
                '<p style="text-align: center; color: #ef4444; padding: 2rem;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫</p>';
        }
    }

    function displaySettingsForm(settings) {
        const container = document.getElementById('formContainer');
        
        container.innerHTML = `
            <form id="settingsForm" class="settings-form">
                <h3 class="section-title">–û—Å–Ω–æ–≤–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</h3>
                
                <div class="form-group">
                    <label for="maxPlayers">–ú–∞–∫—Å–∏–º—É–º –∏–≥—Ä–æ–∫–æ–≤</label>
                    <input type="number" id="maxPlayers" name="max_players" value="${settings.max_players}" min="1" max="1000">
                    <small>–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏–≥—Ä–æ–∫–æ–≤ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ</small>
                </div>

                <div class="form-group">
                    <label for="motd">MOTD (–°–æ–æ–±—â–µ–Ω–∏–µ –¥–Ω—è)</label>
                    <textarea id="motd" name="motd">${settings.motd || ''}</textarea>
                    <small>–°–æ–æ–±—â–µ–Ω–∏–µ, –∫–æ—Ç–æ—Ä–æ–µ –≤–∏–¥—è—Ç –∏–≥—Ä–æ–∫–∏ –≤ —Å–ø–∏—Å–∫–µ —Å–µ—Ä–≤–µ—Ä–æ–≤</small>
                </div>

                <h3 class="section-title">–ò–≥—Ä–æ–≤—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</h3>

                <div class="form-group">
                    <label for="difficulty">–°–ª–æ–∂–Ω–æ—Å—Ç—å</label>
                    <select id="difficulty" name="difficulty">
                        <option value="PEACEFUL" ${settings.difficulty === 'PEACEFUL' ? 'selected' : ''}>–ú–∏—Ä–Ω–∞—è</option>
                        <option value="EASY" ${settings.difficulty === 'EASY' ? 'selected' : ''}>–õ–µ–≥–∫–∞—è</option>
                        <option value="NORMAL" ${settings.difficulty === 'NORMAL' ? 'selected' : ''}>–ù–æ—Ä–º–∞–ª—å–Ω–∞—è</option>
                        <option value="HARD" ${settings.difficulty === 'HARD' ? 'selected' : ''}>–°–ª–æ–∂–Ω–∞—è</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="gamemode">–†–µ–∂–∏–º –∏–≥—Ä—ã</label>
                    <select id="gamemode" name="gamemode">
                        <option value="SURVIVAL" ${settings.gamemode === 'SURVIVAL' ? 'selected' : ''}>–í—ã–∂–∏–≤–∞–Ω–∏–µ</option>
                        <option value="CREATIVE" ${settings.gamemode === 'CREATIVE' ? 'selected' : ''}>–¢–≤–æ—Ä—á–µ—Å—Ç–≤–æ</option>
                        <option value="ADVENTURE" ${settings.gamemode === 'ADVENTURE' ? 'selected' : ''}>–ü—Ä–∏–∫–ª—é—á–µ–Ω–∏–µ</option>
                        <option value="SPECTATOR" ${settings.gamemode === 'SPECTATOR' ? 'selected' : ''}>–ù–∞–±–ª—é–¥–∞—Ç–µ–ª—å</option>
                    </select>
                </div>

                <h3 class="section-title">–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</h3>

                <div class="form-group checkbox-group">
                    <input type="checkbox" id="pvp" name="pvp" ${settings.pvp ? 'checked' : ''}>
                    <label for="pvp">PvP (–ò–≥—Ä–æ–∫ –ø—Ä–æ—Ç–∏–≤ –∏–≥—Ä–æ–∫–∞)</label>
                </div>

                <div class="form-group checkbox-group">
                    <input type="checkbox" id="hardcore" name="hardcore" ${settings.hardcore ? 'checked' : ''}>
                    <label for="hardcore">–•–∞—Ä–¥–∫–æ—Ä —Ä–µ–∂–∏–º</label>
                </div>

                <div class="form-group checkbox-group">
                    <input type="checkbox" id="allowFlight" name="allow_flight" ${settings.allow_flight ? 'checked' : ''}>
                    <label for="allowFlight">–†–∞–∑—Ä–µ—à–∏—Ç—å –ø–æ–ª–µ—Ç</label>
                </div>

                <div class="form-group checkbox-group">
                    <input type="checkbox" id="spawnMonsters" name="spawn_monsters" ${settings.spawn_monsters ? 'checked' : ''}>
                    <label for="spawnMonsters">–°–ø–∞–≤–Ω –º–æ–Ω—Å—Ç—Ä–æ–≤</label>
                </div>

                <div class="form-group checkbox-group">
                    <input type="checkbox" id="spawnAnimals" name="spawn_animals" ${settings.spawn_animals ? 'checked' : ''}>
                    <label for="spawnAnimals">–°–ø–∞–≤–Ω –∂–∏–≤–æ—Ç–Ω—ã—Ö</label>
                </div>

                <div class="form-group checkbox-group">
                    <input type="checkbox" id="whiteList" name="white_list" ${settings.white_list ? 'checked' : ''}>
                    <label for="whiteList">–ë–µ–ª—ã–π —Å–ø–∏—Å–æ–∫</label>
                </div>

                <div class="form-actions">
                    <button type="submit" class="btn" style="background: #10b981;">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                    <button type="button" id="resetBtn" class="btn" style="background: #6b7280;">üîÑ –°–±—Ä–æ—Å–∏—Ç—å</button>
                </div>
            </form>
        `;

        document.getElementById('settingsForm').addEventListener('submit', saveSettings);
        document.getElementById('resetBtn').addEventListener('click', loadSettings);
    }

    async function saveSettings(e) {
        e.preventDefault();

        const formData = new FormData(e.target);
        const data = {
            server: serverId,
            max_players: parseInt(formData.get('max_players')),
            difficulty: formData.get('difficulty'),
            gamemode: formData.get('gamemode'),
            pvp: formData.get('pvp') === 'on',
            hardcore: formData.get('hardcore') === 'on',
            allow_flight: formData.get('allow_flight') === 'on',
            spawn_monsters: formData.get('spawn_monsters') === 'on',
            spawn_animals: formData.get('spawn_animals') === 'on',
            white_list: formData.get('white_list') === 'on',
            motd: formData.get('motd')
        };

        const submitBtn = e.target.querySelector('button[type="submit"]');
        submitBtn.disabled = true;
        submitBtn.textContent = '‚è≥ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...';

        try {
            const url = settingsId ? `${apiBase}/settings/${settingsId}/` : `${apiBase}/settings/`;
            const method = settingsId ? 'PUT' : 'POST';

            const response = await fetch(url, {
                method: method,
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify(data)
            });

            if (response.ok) {
                showAlert('–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã!', 'success');
                const savedData = await response.json();
                settingsId = savedData.id;
            } else {
                const error = await response.json();
                showAlert(error.detail || '–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫', 'error');
            }
        } catch (error) {
            showAlert(`–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ${error.message}`, 'error');
        } finally {
            submitBtn.disabled = false;
            submitBtn.textContent = 'üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å';
        }
    }

    // –ó–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    loadServerInfo();
    loadSettings();
</script>
{% endblock %}
