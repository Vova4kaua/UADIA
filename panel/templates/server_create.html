{% extends 'base.html' %}

{% block title %}–°–æ–∑–¥–∞—Ç—å –°–µ—Ä–≤–µ—Ä{% endblock %}

{% block extra_css %}
<style>
    .create-form {
        max-width: 700px;
        margin: 0 auto;
    }

    .form-group {
        margin-bottom: 1.5rem;
    }

    .form-group label {
        display: block;
        color: #374151;
        font-weight: 600;
        margin-bottom: 0.5rem;
    }

    .form-group label span {
        color: #ef4444;
    }

    .form-group input,
    .form-group select {
        width: 100%;
        padding: 0.75rem;
        border: 2px solid #e5e7eb;
        border-radius: 8px;
        font-size: 1rem;
        transition: all 0.3s;
    }

    .form-group input:focus,
    .form-group select:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .form-group small {
        display: block;
        color: #6b7280;
        margin-top: 0.25rem;
        font-size: 0.875rem;
    }

    .form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1rem;
    }

    .section-title {
        color: #667eea;
        border-bottom: 2px solid #667eea;
        padding-bottom: 0.5rem;
        margin-bottom: 1.5rem;
        margin-top: 2rem;
    }

    .alert {
        padding: 1rem;
        border-radius: 5px;
        margin-bottom: 1rem;
        font-weight: 500;
    }

    .alert-error {
        background: #fee2e2;
        color: #991b1b;
        border: 1px solid #ef4444;
    }

    .alert-success {
        background: #d1fae5;
        color: #065f46;
        border: 1px solid #10b981;
    }

    .submit-btn {
        width: 100%;
        padding: 1rem;
        font-size: 1.1rem;
        font-weight: 600;
        margin-top: 2rem;
    }

    .loading-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0,0,0,0.7);
        z-index: 9999;
        align-items: center;
        justify-content: center;
    }

    .loading-overlay.active {
        display: flex;
    }

    .loading-content {
        background: white;
        padding: 2rem 3rem;
        border-radius: 10px;
        text-align: center;
    }

    .spinner {
        border: 4px solid #f3f4f6;
        border-top: 4px solid #667eea;
        border-radius: 50%;
        width: 50px;
        height: 50px;
        animation: spin 1s linear infinite;
        margin: 0 auto 1rem;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
</style>
{% endblock %}

{% block content %}
<div class="loading-overlay" id="loadingOverlay">
    <div class="loading-content">
        <div class="spinner"></div>
        <h3 style="color: #667eea;">–°–æ–∑–¥–∞–µ–º —Å–µ—Ä–≤–µ—Ä...</h3>
        <p style="color: #6b7280;">–≠—Ç–æ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –º–∏–Ω—É—Ç</p>
    </div>
</div>

<div class="card">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
        <h2 style="color: #667eea;">üéÆ –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π —Å–µ—Ä–≤–µ—Ä</h2>
        <a href="{% url 'panel:server_list' %}" class="btn" style="background: #6b7280;">‚Üê –ù–∞–∑–∞–¥</a>
    </div>

    <div id="alertContainer"></div>

    <form id="createServerForm" class="create-form">
        <h3 class="section-title">–û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h3>

        <div class="form-group">
            <label for="serverName">–ù–∞–∑–≤–∞–Ω–∏–µ —Å–µ—Ä–≤–µ—Ä–∞ <span>*</span></label>
            <input type="text" id="serverName" name="name" required placeholder="–ú–æ–π Minecraft –°–µ—Ä–≤–µ—Ä">
            <small>–£–Ω–∏–∫–∞–ª—å–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –¥–ª—è –≤–∞—à–µ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞</small>
        </div>

        <div class="form-row">
            <div class="form-group">
                <label for="serverType">–¢–∏–ø —Å–µ—Ä–≤–µ—Ä–∞ <span>*</span></label>
                <select id="serverType" name="server_type" required>
                    <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø...</option>
                </select>
                <small>Paper —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –¥–ª—è –±–æ–ª—å—à–∏–Ω—Å—Ç–≤–∞ —Å–ª—É—á–∞–µ–≤</small>
            </div>

            <div class="form-group">
                <label for="minecraftVersion">–í–µ—Ä—Å–∏—è Minecraft <span>*</span></label>
                <select id="minecraftVersion" name="minecraft_version" required>
                    <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –≤–µ—Ä—Å–∏—é...</option>
                </select>
                <small>–ü–æ—Å–ª–µ–¥–Ω—è—è —Å—Ç–∞–±–∏–ª—å–Ω–∞—è –≤–µ—Ä—Å–∏—è</small>
            </div>
        </div>

        <h3 class="section-title">–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–µ—Ä–≤–µ—Ä–∞</h3>

        <div class="form-row">
            <div class="form-group">
                <label for="serverPort">–ü–æ—Ä—Ç <span>*</span></label>
                <input type="number" id="serverPort" name="port" value="25565" required min="1024" max="65535">
                <small>–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –ø–æ—Ä—Ç: 25565</small>
            </div>

            <div class="form-group">
                <label for="serverMemory">–ü–∞–º—è—Ç—å (RAM) <span>*</span></label>
                <select id="serverMemory" name="memory" required>
                    <option value="1G">1 GB</option>
                    <option value="2G" selected>2 GB (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)</option>
                    <option value="3G">3 GB</option>
                    <option value="4G">4 GB</option>
                    <option value="6G">6 GB</option>
                    <option value="8G">8 GB</option>
                    <option value="12G">12 GB</option>
                    <option value="16G">16 GB</option>
                </select>
                <small>–ë–æ–ª—å—à–µ –ø–∞–º—è—Ç–∏ = –ª—É—á—à–µ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å</small>
            </div>
        </div>

        <h3 class="section-title">–ò–≥—Ä–æ–≤—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</h3>

        <div class="form-row">
            <div class="form-group">
                <label for="maxPlayers">–ú–∞–∫—Å. –∏–≥—Ä–æ–∫–æ–≤</label>
                <input type="number" id="maxPlayers" name="max_players" value="20" min="1" max="1000">
                <small>–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏–≥—Ä–æ–∫–æ–≤</small>
            </div>

            <div class="form-group">
                <label for="difficulty">–°–ª–æ–∂–Ω–æ—Å—Ç—å</label>
                <select id="difficulty" name="difficulty">
                    <option value="PEACEFUL">–ú–∏—Ä–Ω–∞—è</option>
                    <option value="EASY">–õ–µ–≥–∫–∞—è</option>
                    <option value="NORMAL" selected>–ù–æ—Ä–º–∞–ª—å–Ω–∞—è</option>
                    <option value="HARD">–°–ª–æ–∂–Ω–∞—è</option>
                </select>
            </div>
        </div>

        <div class="form-row">
            <div class="form-group">
                <label for="gamemode">–†–µ–∂–∏–º –∏–≥—Ä—ã</label>
                <select id="gamemode" name="gamemode">
                    <option value="SURVIVAL" selected>–í—ã–∂–∏–≤–∞–Ω–∏–µ</option>
                    <option value="CREATIVE">–¢–≤–æ—Ä—á–µ—Å—Ç–≤–æ</option>
                    <option value="ADVENTURE">–ü—Ä–∏–∫–ª—é—á–µ–Ω–∏–µ</option>
                    <option value="SPECTATOR">–ù–∞–±–ª—é–¥–∞—Ç–µ–ª—å</option>
                </select>
            </div>

            <div class="form-group">
                <label for="motd">MOTD (–û–ø–∏—Å–∞–Ω–∏–µ)</label>
                <input type="text" id="motd" name="motd" placeholder="–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –Ω–∞ —Å–µ—Ä–≤–µ—Ä!">
                <small>–°–æ–æ–±—â–µ–Ω–∏–µ –≤ —Å–ø–∏—Å–∫–µ —Å–µ—Ä–≤–µ—Ä–æ–≤</small>
            </div>
        </div>

        <button type="submit" class="btn submit-btn">
            üöÄ –°–æ–∑–¥–∞—Ç—å —Å–µ—Ä–≤–µ—Ä
        </button>
    </form>
</div>
{% endblock %}

{% block extra_js %}
<script>
    const apiBase = '/api';

    function showAlert(message, type) {
        const alertContainer = document.getElementById('alertContainer');
        const alert = document.createElement('div');
        alert.className = `alert alert-${type}`;
        alert.textContent = message;
        alertContainer.appendChild(alert);
        
        setTimeout(() => {
            alert.remove();
        }, 5000);
    }

    function showLoading() {
        document.getElementById('loadingOverlay').classList.add('active');
    }

    function hideLoading() {
        document.getElementById('loadingOverlay').classList.remove('active');
    }

    async function loadServerTypes() {
        try {
            const response = await fetch(`${apiBase}/servers/available_types/`);
            const types = await response.json();
            
            const select = document.getElementById('serverType');
            types.forEach(type => {
                const option = document.createElement('option');
                option.value = type.value;
                option.textContent = type.label;
                if (type.value === 'PAPER') {
                    option.selected = true;
                }
                select.appendChild(option);
            });
        } catch (error) {
            console.error('Error loading server types:', error);
            showAlert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–∏–ø–æ–≤ —Å–µ—Ä–≤–µ—Ä–æ–≤', 'error');
        }
    }

    async function loadMinecraftVersions() {
        try {
            const response = await fetch(`${apiBase}/servers/available_versions/`);
            const versions = await response.json();
            
            const select = document.getElementById('minecraftVersion');
            versions.forEach(version => {
                const option = document.createElement('option');
                option.value = version.version;
                option.textContent = version.version + (version.recommended ? ' (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)' : '');
                if (version.recommended && !select.value) {
                    option.selected = true;
                }
                select.appendChild(option);
            });
        } catch (error) {
            console.error('Error loading versions:', error);
            showAlert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≤–µ—Ä—Å–∏–π Minecraft', 'error');
        }
    }

    async function createServer(formData) {
        showLoading();

        try {
            // –°–æ–∑–¥–∞–µ–º —Å–µ—Ä–≤–µ—Ä
            const response = await fetch(`${apiBase}/servers/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify(formData)
            });

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.detail || '–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Å–µ—Ä–≤–µ—Ä–∞');
            }

            const server = await response.json();

            // –°–æ–∑–¥–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–µ—Ä–≤–µ—Ä–∞
            const settingsData = {
                server: server.id,
                max_players: formData.max_players || 20,
                difficulty: formData.difficulty || 'NORMAL',
                gamemode: formData.gamemode || 'SURVIVAL',
                motd: formData.motd || `Welcome to ${server.name}!`,
                pvp: true,
                hardcore: false,
                allow_flight: false,
                spawn_monsters: true,
                spawn_animals: true,
                white_list: false
            };

            await fetch(`${apiBase}/settings/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify(settingsData)
            });

            hideLoading();
            showAlert('–°–µ—Ä–≤–µ—Ä —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω!', 'success');

            setTimeout(() => {
                window.location.href = `/panel/servers/${server.id}/`;
            }, 2000);

        } catch (error) {
            hideLoading();
            showAlert(error.message || '–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Å–µ—Ä–≤–µ—Ä–∞', 'error');
        }
    }

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    document.getElementById('createServerForm').addEventListener('submit', async (e) => {
        e.preventDefault();

        const formData = {
            name: document.getElementById('serverName').value,
            server_type: document.getElementById('serverType').value,
            minecraft_version: document.getElementById('minecraftVersion').value,
            port: parseInt(document.getElementById('serverPort').value),
            memory: document.getElementById('serverMemory').value,
            max_players: parseInt(document.getElementById('maxPlayers').value),
            difficulty: document.getElementById('difficulty').value,
            gamemode: document.getElementById('gamemode').value,
            motd: document.getElementById('motd').value
        };

        await createServer(formData);
    });

    // –ó–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    loadServerTypes();
    loadMinecraftVersions();
</script>
{% endblock %}
