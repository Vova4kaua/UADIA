{% extends 'base.html' %}

{% block title %}–î–æ–±–∞–≤–∏—Ç—å –ü–ª–∞–≥–∏–Ω{% endblock %}

{% block extra_css %}
<style>
    .create-form {
        max-width: 600px;
        margin: 0 auto;
    }

    .form-group {
        margin-bottom: 1.5rem;
    }

    .form-group label {
        display: block;
        color: #374151;
        font-weight: 600;
        margin-bottom: 0.5rem;
    }

    .form-group label span {
        color: #ef4444;
    }

    .form-group input,
    .form-group textarea {
        width: 100%;
        padding: 0.75rem;
        border: 2px solid #e5e7eb;
        border-radius: 8px;
        font-size: 1rem;
        transition: all 0.3s;
    }

    .form-group input:focus,
    .form-group textarea:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .form-group small {
        display: block;
        color: #6b7280;
        margin-top: 0.25rem;
        font-size: 0.875rem;
    }

    .checkbox-group {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .checkbox-group input[type="checkbox"] {
        width: auto;
        cursor: pointer;
    }

    .submit-btn {
        width: 100%;
        padding: 1rem;
        font-size: 1.1rem;
        font-weight: 600;
        margin-top: 2rem;
    }

    .alert {
        padding: 1rem;
        border-radius: 5px;
        margin-bottom: 1rem;
        font-weight: 500;
    }

    .alert-error {
        background: #fee2e2;
        color: #991b1b;
        border: 1px solid #ef4444;
    }

    .alert-success {
        background: #d1fae5;
        color: #065f46;
        border: 1px solid #10b981;
    }
</style>
{% endblock %}

{% block content %}
<div class="card">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
        <h2 style="color: #667eea;">‚ûï –î–æ–±–∞–≤–∏—Ç—å –ø–ª–∞–≥–∏–Ω</h2>
        <a href="{% url 'panel:plugins' server_id %}" class="btn" style="background: #6b7280;">‚Üê –ù–∞–∑–∞–¥</a>
    </div>

    <div id="alertContainer"></div>

    <form id="addPluginForm" class="create-form">
        <div class="form-group">
            <label for="pluginName">–ù–∞–∑–≤–∞–Ω–∏–µ –ø–ª–∞–≥–∏–Ω–∞ <span>*</span></label>
            <input type="text" id="pluginName" name="name" required placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: EssentialsX">
            <small>–£–Ω–∏–∫–∞–ª—å–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –ø–ª–∞–≥–∏–Ω–∞</small>
        </div>

        <div class="form-group">
            <label for="pluginVersion">–í–µ—Ä—Å–∏—è <span>*</span></label>
            <input type="text" id="pluginVersion" name="version" required placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 2.20.1">
            <small>–í–µ—Ä—Å–∏—è –ø–ª–∞–≥–∏–Ω–∞</small>
        </div>

        <div class="form-group">
            <label for="pluginDescription">–û–ø–∏—Å–∞–Ω–∏–µ</label>
            <textarea id="pluginDescription" name="description" rows="3" placeholder="–ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –ø–ª–∞–≥–∏–Ω–∞"></textarea>
            <small>–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–∞ –ø–ª–∞–≥–∏–Ω–∞</small>
        </div>

        <div class="form-group checkbox-group">
            <input type="checkbox" id="pluginEnabled" name="enabled" checked>
            <label for="pluginEnabled">–í–∫–ª—é—á–∏—Ç—å –ø–ª–∞–≥–∏–Ω –ø–æ—Å–ª–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è</label>
        </div>

        <button type="submit" class="btn submit-btn">
            üíæ –î–æ–±–∞–≤–∏—Ç—å –ø–ª–∞–≥–∏–Ω
        </button>
    </form>
</div>
{% endblock %}

{% block extra_js %}
<script>
    const serverId = {{ server_id }};
    const apiBase = '/api';

    function showAlert(message, type) {
        const alertContainer = document.getElementById('alertContainer');
        const alert = document.createElement('div');
        alert.className = `alert alert-${type}`;
        alert.textContent = message;
        alertContainer.appendChild(alert);
        
        setTimeout(() => {
            alert.remove();
        }, 5000);
    }

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    document.getElementById('addPluginForm').addEventListener('submit', async (e) => {
        e.preventDefault();

        const formData = {
            server: serverId,
            name: document.getElementById('pluginName').value,
            version: document.getElementById('pluginVersion').value,
            description: document.getElementById('pluginDescription').value,
            enabled: document.getElementById('pluginEnabled').checked
        };

        const submitBtn = e.target.querySelector('button[type="submit"]');
        submitBtn.disabled = true;
        submitBtn.textContent = '‚è≥ –î–æ–±–∞–≤–ª–µ–Ω–∏–µ...';

        try {
            const response = await fetch(`${apiBase}/plugins/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify(formData)
            });

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.detail || '–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø–ª–∞–≥–∏–Ω–∞');
            }

            showAlert('–ü–ª–∞–≥–∏–Ω —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω!', 'success');

            setTimeout(() => {
                window.location.href = `/panel/servers/${serverId}/plugins/`;
            }, 1500);

        } catch (error) {
            showAlert(error.message || '–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø–ª–∞–≥–∏–Ω–∞', 'error');
            submitBtn.disabled = false;
            submitBtn.textContent = 'üíæ –î–æ–±–∞–≤–∏—Ç—å –ø–ª–∞–≥–∏–Ω';
        }
    });
</script>
{% endblock %}
